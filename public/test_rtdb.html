<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tes Koneksi Realtime Database</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light p-5">
    <div class="card shadow max-w-lg mx-auto">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Diagnosa Koneksi Database</h4>
        </div>
        <div class="card-body">
            <div id="status" class="alert alert-info">Menghubungkan...</div>
            
            <button onclick="testConnection()" class="btn btn-primary w-100">Cek Koneksi Lagi</button>
            
            <hr>
            <h5>Log Detail:</h5>
            <pre id="logs" class="bg-dark text-white p-3 rounded" style="height: 200px; overflow-y: auto; font-size: 12px;"></pre>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // Konfigurasi Project 'eperpus-sekolah'
        const firebaseConfig = {
            apiKey: "AIzaSyBvmr1cu8-WnGNiD5M_cla6lxr88QEYu28",
            authDomain: "eperpus-sekolah.firebaseapp.com",
            databaseURL: "https://smpn3pacet-app-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "eperpus-sekolah",
            storageBucket: "eperpus-sekolah.firebasestorage.app",
            messagingSenderId: "303647816343",
            appId: "1:303647816343:web:78ad36d2d1be25930547d2"
        };

        const app = initializeApp(firebaseConfig, "TestRTDB");
        const db = getDatabase(app);

        function log(msg) {
            const el = document.getElementById('logs');
            el.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
            el.scrollTop = el.scrollHeight;
            console.log(msg);
        }

        window.testConnection = async () => {
            const statusEl = document.getElementById('status');
            statusEl.className = 'alert alert-info';
            statusEl.textContent = 'Sedang mengecek via REST API...';
            log("Memulai tes koneksi ke: " + firebaseConfig.databaseURL);

            try {
                // 1. Cek Koneksi via REST API (Lebih stabil untuk lintas project)
                const restUrl = `${firebaseConfig.databaseURL}/.json?shallow=true`;
                log(`Mencoba Fetch REST: ${restUrl}`);
                
                const resp = await fetch(restUrl);
                log(`Response Status: ${resp.status} ${resp.statusText}`);
                
                if (resp.ok) {
                    log("✅ REST Read: BERHASIL! Database bisa dibaca.");
                } else if (resp.status === 401) {
                    log("⚠️ REST Read: 401 Unauthorized. Database terkunci (perlu Auth).");
                } else {
                    log("❌ REST Read: Gagal.");
                }

                // 2. Coba SDK (Hanya jika project sama)
                log("Mencoba inisialisasi SDK...");
                try {
                    // Pakai URL eksplisit untuk menghindari mismatch project
                    const db = getDatabase(app, firebaseConfig.databaseURL);
                    const testRef = ref(db, '.info/connected');
                    const snap = await get(testRef);
                    log("✅ SDK Connection: Berhasil terhubung!");
                    
                    statusEl.className = 'alert alert-success';
                    statusEl.textContent = '✅ TERHUBUNG: Database Aman!';
                } catch (sdkErr) {
                    log("⚠️ SDK Error: " + sdkErr.message);
                    log("Info: Jika REST berhasil tapi SDK gagal, kemungkinan beda Project ID.");
                    
                    if (resp.ok) {
                        statusEl.className = 'alert alert-success';
                        statusEl.textContent = '✅ TERHUBUNG (Mode REST)';
                    } else {
                        statusEl.className = 'alert alert-warning';
                        statusEl.textContent = '⚠️ Terhubung tapi Terkunci';
                    }
                }

            } catch (e) {
                log("ERROR FATAL: " + e.message);
                statusEl.className = 'alert alert-danger';
                statusEl.textContent = '❌ GAGAL: ' + e.message;
            }
        };

        // Auto run
        testConnection();
    </script>
</body>
</html>

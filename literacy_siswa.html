<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tugas Literasi Siswa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { 
            background-color: #f8f9fa; 
            padding-bottom: 80px; /* Space for bottom navbar */
        }
        .task-card { transition: transform 0.2s; cursor: pointer; }
        .task-card:hover { transform: translateY(-5px); border-color: #0d6efd; }
        .selected-task { border: 2px solid #0d6efd; background-color: #e7f1ff; }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
        }
        .nav-item {
            text-align: center;
            color: #6c757d;
            font-size: 12px;
            cursor: pointer;
            flex: 1;
        }
        .nav-item i {
            font-size: 20px;
            display: block;
            margin-bottom: 2px;
        }
        .nav-item.active {
            color: #0d6efd;
            font-weight: bold;
        }

        /* View Sections */
        .app-view { display: none; }
        .app-view.active { display: block; }
        
        /* Stats Card */
        .stats-card {
            background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        /* Login Modal Overlay */
        #loginOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.95);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-card {
            width: 100%;
            max-width: 400px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <!-- Login Overlay -->
    <div id="loginOverlay">
        <div class="card login-card p-4">
            <div class="text-center mb-4">
                <h3 class="fw-bold text-primary">üìö Lentera Digital</h3>
                <p class="text-muted small">Masuk untuk mengakses perpustakaan</p>
            </div>
            <form id="loginForm">
                <div class="mb-3">
                    <label class="form-label fw-bold">Username</label>
                    <input type="text" id="inputUsername" class="form-control" placeholder="Contoh: miko" required>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Password (NISN)</label>
                    <input type="password" id="inputPassword" class="form-control" placeholder="Masukkan NISN" required>
                </div>
                <div id="loginError" class="alert alert-danger d-none small py-2"></div>
                <button type="submit" class="btn btn-primary w-100 py-2 fw-bold">
                    <span id="loginBtnText">Masuk</span>
                    <span id="loginSpinner" class="spinner-border spinner-border-sm d-none"></span>
                </button>
            </form>
        </div>
    </div>

    <!-- Top Navbar (Only visible on specific views if needed, currently global) -->
    <nav class="navbar navbar-light bg-white shadow-sm sticky-top">
        <div class="container-fluid">
            <span class="navbar-brand fw-bold mb-0 h1"><i class="bi bi-book-half text-primary"></i> Lentera Digital</span>
            <span class="navbar-text small text-muted" id="userDisplay">Guest</span>
        </div>
    </nav>

    <div class="container mt-4">
        
        <!-- VIEW: BERANDA -->
        <div id="view-home" class="app-view">
            <div class="stats-card shadow">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h5 class="mb-0">Halo, <span class="student-name-display">Siswa</span>!</h5>
                        <small class="text-white-50">Selamat datang kembali</small>
                    </div>
                    <div class="bg-white text-primary rounded-circle p-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                        <span class="fw-bold student-initial-display">S</span>
                    </div>
                </div>
                <div class="row text-center">
                    <div class="col-6 border-end border-white-50">
                        <h3 class="fw-bold mb-0">1,250</h3>
                        <small>Total Poin</small>
                    </div>
                    <div class="col-6">
                        <h3 class="fw-bold mb-0">12</h3>
                        <small>Buku Dibaca</small>
                    </div>
                </div>
            </div>

            <h6 class="fw-bold mb-3">Tantangan Minggu Ini</h6>
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                    <span class="badge bg-warning text-dark mb-2">Populer</span>
                    <h5 class="card-title fw-bold" id="featured-task-title">Memuat tantangan...</h5>
                    <p class="card-text small text-muted" id="featured-task-desc">...</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted" id="featured-task-deadline"><i class="bi bi-clock"></i> ...</small>
                        <span class="text-warning fw-bold" id="featured-task-points"><i class="bi bi-star-fill"></i> ...</span>
                    </div>
                    <button id="featured-task-btn" onclick="switchView('tasks')" class="btn btn-primary btn-sm w-100 mt-3">Lihat Tugas</button>
                </div>
            </div>
        </div>

        <!-- VIEW: KATALOG -->
        <div id="view-catalog" class="app-view">
            <h5 class="fw-bold mb-3">üìö Katalog Buku</h5>
            
            <!-- Category Tabs (Scrollable) -->
            <div class="d-flex overflow-auto mb-3 pb-2 no-scrollbar" style="white-space: nowrap; -ms-overflow-style: none; scrollbar-width: none;">
                <button onclick="filterCatalog('all', this)" class="btn btn-sm btn-primary me-2 rounded-pill category-btn active">Semua</button>
                <button onclick="filterCatalog('FIKSI & SASTRA', this)" class="btn btn-sm btn-outline-secondary me-2 rounded-pill category-btn">Fiksi & Sastra</button>
                <button onclick="filterCatalog('BUKU PELAJARAN', this)" class="btn btn-sm btn-outline-secondary me-2 rounded-pill category-btn">Buku Pelajaran</button>
                <button onclick="filterCatalog('NON-FIKSI', this)" class="btn btn-sm btn-outline-secondary me-2 rounded-pill category-btn">Non-Fiksi</button>
                <button onclick="filterCatalog('PENGEMBANGAN DIRI', this)" class="btn btn-sm btn-outline-secondary me-2 rounded-pill category-btn">Pengembangan Diri</button>
                <button onclick="filterCatalog('MINAT', this)" class="btn btn-sm btn-outline-secondary me-2 rounded-pill category-btn">Minat & Bakat</button>
                <button onclick="filterCatalog('MAJALAH', this)" class="btn btn-sm btn-outline-secondary me-2 rounded-pill category-btn">Majalah</button>
                <button onclick="filterCatalog('LAINNYA', this)" class="btn btn-sm btn-outline-secondary me-2 rounded-pill category-btn">Lainnya</button>
            </div>

            <div class="input-group mb-3">
                <input type="text" id="searchBookInput" class="form-control" placeholder="Cari judul buku..." onkeyup="searchCatalog()">
                <button class="btn btn-outline-primary" type="button"><i class="bi bi-search"></i></button>
            </div>
            
            <!-- Catalog Grid -->
            <div id="catalogGrid" class="row g-3">
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">Memuat buku dari perpustakaan...</p>
                </div>
            </div>
        </div>

        <!-- VIEW: TUGAS (Existing Logic Moved Here) -->
        <div id="view-tasks" class="app-view active">
            
            <!-- Identity Hidden (Handled by Login) -->
            <div class="d-none">
                <input type="text" id="studentName">
                <input type="text" id="studentClass">
            </div>

            <!-- Daftar Tugas Aktif -->
            <div class="mb-4">
                <h5 class="fw-bold mb-3">üìù Tugas Literasi</h5>
                <div class="btn-group w-100 mb-3" role="group">
                    <button type="button" class="btn btn-primary active">Tugas Baru</button>
                    <button type="button" class="btn btn-outline-primary">Riwayat</button>
                </div>
                
                <div id="taskList" class="row">
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 text-muted">Memuat tugas...</p>
                    </div>
                </div>
            </div>

            <!-- Form Pengerjaan (Hidden sampai tugas dipilih) -->
            <div id="submissionArea" class="card shadow-lg border-primary d-none position-fixed bottom-0 start-0 w-100 rounded-top" style="z-index: 2000; height: 80vh; overflow-y: auto;">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-pencil-square"></i> Kerjakan Tugas</span>
                    <button type="button" class="btn-close btn-close-white" onclick="closeSubmission()"></button>
                </div>
                <div class="card-body">
                    <h6 id="selectedTaskTitle" class="fw-bold mb-3 text-primary"></h6>
                    <form id="submissionForm">
                        <input type="hidden" id="taskId">
                        
                        <div class="mb-3">
                            <label class="form-label">Judul Buku</label>
                            <input type="text" id="bookTitle" class="form-control" required placeholder="Buku yang dibaca...">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Ringkasan</label>
                            <textarea id="summary" class="form-control" rows="8" required placeholder="Tulis ringkasanmu disini..."></textarea>
                        </div>

                        <button type="submit" class="btn btn-success w-100 py-3 fw-bold mb-5">
                            <i class="bi bi-send-fill"></i> Kirim Laporan
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- VIEW: BUKU SAYA -->
        <div id="view-mybooks" class="app-view">
            <h5 class="fw-bold mb-3">üìñ Buku Saya</h5>
            <div class="text-center py-5 text-muted">
                <i class="bi bi-journal-bookmark display-1"></i>
                <p class="mt-3">Belum ada buku yang disimpan.</p>
            </div>
        </div>

        <!-- VIEW: PROFIL -->
        <div id="view-profile" class="app-view">
            <h5 class="fw-bold mb-3">üë§ Profil Saya</h5>
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px; font-size: 32px;">
                        S
                    </div>
                    <h4 class="fw-bold student-name-display">Nama Siswa</h4>
                    <p class="text-muted student-class-display">Kelas VII-A</p>
                    <hr>
                    <div class="text-start">
                        <p><strong>NISN:</strong> <span id="profile-nisn">-</span></p>
                        <p><strong>Sekolah:</strong> SMPN 3 Pacet</p>
                    </div>
                    <button onclick="window.logoutStudent()" class="btn btn-outline-danger w-100 mt-3">
                        <i class="bi bi-box-arrow-right"></i> Keluar
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- Bottom Navigation Bar -->
    <div class="bottom-nav">
        <div class="nav-item" onclick="switchView('home')" id="nav-home">
            <i class="bi bi-house-door"></i> Beranda
        </div>
        <div class="nav-item" onclick="switchView('catalog')" id="nav-catalog">
            <i class="bi bi-grid"></i> Katalog
        </div>
        <div class="nav-item active" onclick="switchView('tasks')" id="nav-tasks">
            <i class="bi bi-pen"></i> Tugas Literasi
        </div>
        <div class="nav-item" onclick="switchView('mybooks')" id="nav-mybooks">
            <i class="bi bi-journal-text"></i> Buku Saya
        </div>
        <div class="nav-item" onclick="switchView('profile')" id="nav-profile">
            <i class="bi bi-person"></i> Profil
        </div>
    </div>

    <!-- Toast Notifikasi -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-success text-white">
                <strong class="me-auto">Berhasil</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body bg-white">
                Laporan berhasil dikirim ke Guru!
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Konfigurasi Database (Firestore)
        const firebaseConfig = {
            apiKey: "AIzaSyBvmr1cu8-WnGNiD5M_cla6lxr88QEYu28",
            authDomain: "eperpus-sekolah.firebaseapp.com",
            projectId: "eperpus-sekolah",
            storageBucket: "eperpus-sekolah.firebasestorage.app",
            messagingSenderId: "303647816343",
            appId: "1:303647816343:web:78ad36d2d1be25930547d2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // RTDB URL for submission (Keep existing)
        const DB_URL = "https://smpn3pacet-app-default-rtdb.asia-southeast1.firebasedatabase.app";

        // --- Login Logic ---
        const loginForm = document.getElementById('loginForm');
        
        // Handle URL Parameters for Auto-Login (Bypass)
        // Example: ?u=miko&p=12345678
        const urlParams = new URLSearchParams(window.location.search);
        const urlUser = urlParams.get('u') || urlParams.get('user') || urlParams.get('username');
        const urlPass = urlParams.get('p') || urlParams.get('pass') || urlParams.get('password');

        if (urlUser && urlPass) {
             console.log("Auto-login via URL detected");
             attemptLogin(urlUser, urlPass);
        }

        if (loginForm) {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('inputUsername').value.trim();
                const password = document.getElementById('inputPassword').value.trim();
                
                if(!username || !password) return;
                attemptLogin(username, password);
            });
        }

        async function attemptLogin(username, password) {
            setLoading(true);
            showError(""); // Clear error
            
            try {
                // Try to find student by username in multiple collections
                console.log(`Searching for student: ${username}`);
                
                // Parallel search in potential collections
                const collections = ["students", "siswa", "users", "anggota"];
                let foundStudent = null;
                let debugMsg = "";

                for (const colName of collections) {
                    debugMsg += `Checking ${colName}... `;
                    const q = query(collection(db, colName), where("username", "==", username));
                    const querySnapshot = await getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        querySnapshot.forEach((doc) => {
                            const data = doc.data();
                            // Check password/NISN (Flexible check)
                            if (data.password == password || data.nisn == password || data.nis == password) {
                                foundStudent = { ...data, id: doc.id };
                            }
                        });
                    }
                    if (foundStudent) break;
                }

                if (foundStudent) {
                    // Success
                    sessionStorage.setItem('student_user', JSON.stringify(foundStudent));
                    applyStudentData(foundStudent);
                } else {
                    // Try Case-Insensitive fallback manually (costly but useful for retry)
                    // Note: Firestore doesn't support native case-insensitive query without specific setup.
                    // We will just report error for now.
                    console.warn(debugMsg);
                    showError("Akun tidak ditemukan atau Password salah. (Cek: " + username + ")");
                }

            } catch (err) {
                console.error(err);
                showError("Terjadi kesalahan koneksi: " + err.message);
            } finally {
                setLoading(false);
            }
        }

        function applyStudentData(student) {
            const overlay = document.getElementById('loginOverlay');
            if(overlay) overlay.style.display = 'none';
            
            const displayName = student.name || student.fullName || student.nama_lengkap || student.username;
            document.getElementById('userDisplay').innerText = `Halo, ${displayName}`;
            
            // Update all elements with class 'student-name-display'
            const nameElements = document.querySelectorAll('.student-name-display');
            nameElements.forEach(el => el.innerText = displayName);

            // Update initial
            const initial = displayName.charAt(0).toUpperCase();
            const initialElements = document.querySelectorAll('.student-initial-display');
            initialElements.forEach(el => el.innerText = initial);
            
            const nameInput = document.getElementById('studentName');
            const classInput = document.getElementById('studentClass');
            
            nameInput.value = displayName;
            
            // Normalize class format (e.g. "7A" -> "VII-A")
            let studentClass = student.class || student.kelas || "";
            // Simple mapping attempt if needed, but let's assume raw data is OK or user corrects it
            classInput.value = studentClass;
            
            // Make readonly to prevent tampering, but allow class change if empty/wrong?
            // User requested automation, so let's lock it to show "We know who you are".
            nameInput.readOnly = true;
            
            // Load tasks immediately after login
            loadTasks();
            loadFeaturedTask();
        }

        async function loadFeaturedTask() {
            try {
                // Fetch latest task from Firestore 'literacy_tasks'
                // Assuming 'createdAt' or just get any document if no proper timestamp
                const q = query(collection(db, "literacy_tasks"), limit(1));
                // If you have a createdAt field, use: orderBy("createdAt", "desc"), limit(1)
                
                const snap = await getDocs(q);
                if (!snap.empty) {
                    const task = snap.docs[0].data();
                    document.getElementById('featured-task-title').innerText = task.title || "Tugas Mingguan";
                    document.getElementById('featured-task-desc').innerText = task.description || "Kerjakan tugas literasi baru ini!";
                    document.getElementById('featured-task-deadline').innerHTML = `<i class="bi bi-clock"></i> ${task.duration || '60'} Menit`;
                    document.getElementById('featured-task-points').innerHTML = `<i class="bi bi-star-fill"></i> ${task.points || '10'} Poin`;
                } else {
                    document.getElementById('featured-task-title').innerText = "Tidak ada tantangan aktif";
                    document.getElementById('featured-task-desc').innerText = "Istirahat dulu sejenak.";
                }
            } catch (e) {
                console.error("Error loading featured task:", e);
            }
        }

        // --- Catalog Logic ---
        let allBooks = [];
        let currentCategory = 'all';

        window.loadCatalog = async function() {
            const grid = document.getElementById('catalogGrid');
            if(!grid) return;

            try {
                // Fetch books from Firestore
                // Assumes collection name "books" based on admin portal convention
                const q = query(collection(db, "books")); 
                const querySnapshot = await getDocs(q);
                
                allBooks = [];
                querySnapshot.forEach((doc) => {
                    allBooks.push({ id: doc.id, ...doc.data() });
                });

                // If empty, add some mock data if strictly needed or just show empty state
                // But for "sync", we prefer real data. If 0 real data, show empty.
                
                renderCatalog(allBooks);
                
            } catch (e) {
                console.error("Error loading catalog:", e);
                grid.innerHTML = `<div class="col-12 text-center text-danger"><p>Gagal memuat katalog: ${e.message}</p></div>`;
            }
        }

        window.renderCatalog = function(books) {
            const grid = document.getElementById('catalogGrid');
            grid.innerHTML = '';

            if (books.length === 0) {
                grid.innerHTML = `
                    <div class="col-12 text-center py-5 text-muted">
                        <i class="bi bi-book display-1"></i>
                        <p class="mt-3">Tidak ada buku ditemukan.</p>
                    </div>`;
                return;
            }

            books.forEach(book => {
                // Fallback values
                const title = book.title || book.judul || "Tanpa Judul";
                const author = book.author || book.penulis || "Tidak diketahui";
                const cover = book.coverUrl || book.cover || null;
                let category = book.category || book.kategori || "Umum";
                
                // Logika Tampilan Kategori (Ambil Sub-Kategori/Level 2 jika ada)
                // Aturan Admin: 
                // 1. Fiksi: Kategori > Sub > Detail (Ambil Sub)
                // 2. Lainnya: Kategori > Sub (Ambil Sub)
                let displayCategory = category;
                let fullCategory = category; // Simpan kategori lengkap untuk tooltip
                
                // Gunakan Regex untuk split yang lebih aman (menangani spasi di sekitar >)
                if (category.includes('>')) {
                    const parts = category.split(/\s*>\s*/);
                    // Ambil bagian kedua (index 1) sebagai Sub-Kategori
                    if (parts.length >= 2) {
                        displayCategory = parts[1].trim();
                    } else {
                        displayCategory = parts[0].trim();
                    }
                }

                const col = document.createElement('div');
                col.className = 'col-6 col-md-4 col-lg-3';
                col.innerHTML = `
                    <div class="card h-100 border-0 shadow-sm task-card" onclick="openBook('${book.id}')">
                        <div class="position-relative" style="height: 180px; background: #eee; overflow: hidden; border-radius: 10px 10px 0 0;">
                            ${cover ? `<img src="${cover}" alt="${title}" style="width: 100%; height: 100%; object-fit: cover;">` 
                                    : `<div class="d-flex align-items-center justify-content-center h-100 text-secondary"><i class="bi bi-book h1"></i></div>`}
                            <span class="position-absolute top-0 end-0 badge bg-primary m-2 shadow-sm" style="font-size: 10px;">${displayCategory}</span>
                        </div>
                        <div class="card-body p-2">
                            <h6 class="card-title small fw-bold mb-1 text-truncate" title="${title}">${title}</h6>
                            <div class="d-flex align-items-center mb-1">
                                <span class="badge bg-light text-secondary border px-1" style="font-size: 9px;" title="${fullCategory}">${displayCategory}</span>
                            </div>
                            <small class="text-muted d-block mb-2 text-truncate">${author}</small>
                            <button class="btn btn-outline-primary btn-sm w-100 py-0" style="font-size: 12px;">Lihat Detail</button>
                        </div>
                    </div>
                `;
                grid.appendChild(col);
            });
        }

        window.filterCatalog = function(category, btn) {
            currentCategory = category;
            
            // Update UI buttons
            document.querySelectorAll('.category-btn').forEach(b => {
                b.classList.remove('btn-primary', 'active');
                b.classList.add('btn-outline-secondary');
            });
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-primary', 'active');

            // Filter logic
            if (category === 'all') {
                searchCatalog(); // Re-apply search filter if any
            } else {
                const filtered = allBooks.filter(b => {
                    const cat = (b.category || b.kategori || "").toUpperCase();
                    // Flexible matching
                    return cat.includes(category);
                });
                renderCatalog(filtered);
            }
        }

        window.searchCatalog = function() {
            const query = document.getElementById('searchBookInput').value.toLowerCase();
            
            let filtered = allBooks.filter(b => {
                const title = (b.title || b.judul || "").toLowerCase();
                const author = (b.author || b.penulis || "").toLowerCase();
                const cat = (b.category || b.kategori || "").toLowerCase();
                return title.includes(query) || author.includes(query) || cat.includes(query);
            });

            // Apply category filter on top if not 'all'
            if (currentCategory !== 'all') {
                filtered = filtered.filter(b => {
                    const cat = (b.category || b.kategori || "").toUpperCase();
                    return cat.includes(currentCategory);
                });
            }

            renderCatalog(filtered);
        }

        window.openBook = function(bookId) {
            // Placeholder for book detail or reading view
            // Can be expanded later
            alert("Fitur detail buku akan segera hadir! ID: " + bookId);
        }

        // Call loadCatalog on startup
        loadCatalog();

        function setLoading(isLoading) {
            const btnText = document.getElementById('loginBtnText');
            const spinner = document.getElementById('loginSpinner');
            if (isLoading) {
                btnText.classList.add('d-none');
                spinner.classList.remove('d-none');
            } else {
                btnText.classList.remove('d-none');
                spinner.classList.add('d-none');
            }
        }

        function showError(msg) {
            const el = document.getElementById('loginError');
            if(msg) {
                el.innerText = msg;
                el.classList.remove('d-none');
            } else {
                el.classList.add('d-none');
            }
        }

        // Logout function (Optional, for testing)
        window.logoutStudent = () => {
            sessionStorage.removeItem('student_user');
            location.reload();
        };

        // Check if already logged in
        const saved = sessionStorage.getItem('student_user');
        if (saved) {
            applyStudentData(JSON.parse(saved));
        }

        
        // --- Navigation Logic ---
        window.switchView = (viewName) => {
            // Update Active View
            document.querySelectorAll('.app-view').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');
            
            // Update Navbar State
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${viewName}`).classList.add('active');

            // Close submission form if open
            if(viewName !== 'tasks') {
                closeSubmission();
            }
        };

        window.closeSubmission = () => {
            document.getElementById('submissionArea').classList.add('d-none');
            // Remove backdrop if we add one later
        }

        // --- 1. Load Tasks (Read from RTDB) ---
        async function loadTasks() {
            try {
                const resp = await fetch(`${DB_URL}/literacy_tasks.json`);
                const data = await resp.json();
                
                const container = document.getElementById('taskList');
                container.innerHTML = '';

                if (!data) {
                    container.innerHTML = '<div class="col-12 text-center text-muted">Belum ada tugas aktif.</div>';
                    return;
                }

                Object.keys(data).forEach(key => {
                    const task = data[key];
                    if (task.isActive === false) return; // Skip non-active

                    const col = document.createElement('div');
                    col.className = 'col-12 mb-3'; // Full width for mobile list style
                    col.innerHTML = `
                        <div class="card task-card shadow-sm border-0 h-100" onclick="selectTask('${key}', '${task.title}')" id="card-${key}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <h6 class="card-title fw-bold text-primary mb-1">${task.title}</h6>
                                    <span class="badge bg-warning text-dark rounded-pill">${task.points} Poin</span>
                                </div>
                                <p class="card-text small text-muted mb-2">${task.description}</p>
                                <small class="text-secondary"><i class="bi bi-clock"></i> ${task.durationMinutes} Menit</small>
                            </div>
                        </div>
                    `;
                    container.appendChild(col);
                });

            } catch (e) {
                console.error(e);
                document.getElementById('taskList').innerHTML = `<div class="alert alert-danger">Gagal memuat tugas: ${e.message}</div>`;
            }
        }

        // --- 2. UI Interaction ---
        window.selectTask = (id, title) => {
            // Show form
            document.getElementById('taskId').value = id;
            document.getElementById('selectedTaskTitle').innerText = title;
            document.getElementById('submissionArea').classList.remove('d-none');
        };

        // --- 3. Submit Logic (Write to RTDB via REST) ---
        document.getElementById('submissionForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Validate Identity
            const name = document.getElementById('studentName').value.trim();
            const kelas = document.getElementById('studentClass').value;
            
            if (!name || !kelas) {
                alert("Sesi kadaluarsa. Silakan login ulang.");
                location.reload();
                return;
            }

            const submitBtn = e.target.querySelector('button');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Mengirim...';

            const payload = {
                taskId: document.getElementById('taskId').value,
                taskTitle: document.getElementById('selectedTaskTitle').innerText,
                // Kirim berbagai variasi field nama untuk kompatibilitas Aplikasi Guru
                studentName: name,
                name: name,
                userName: name,
                displayName: name,
                sender: name,
                class: kelas, // Kirim kelas
                kelas: kelas,
                timestamp: Date.now(),
                submittedAt: new Date().toISOString(),
                bookTitle: document.getElementById('bookTitle').value,
                summary: document.getElementById('summary').value,
                status: 'submitted',
                points: 0 // Pending approval
            };

            try {
                await fetch(`${DB_URL}/literacy_logs.json`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // Show success
                const toast = new bootstrap.Toast(document.getElementById('liveToast'));
                toast.show();
                
                // Reset form
                e.target.reset();
                closeSubmission();
                switchView('home'); // Go back to home after submission? Or stay in tasks?
                
            } catch (err) {
                alert("Gagal mengirim laporan: " + err.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-send-fill"></i> Kirim Laporan';
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
